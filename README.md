# SkyCommerce

SkyCommerce is a Spring Boot application that manages clients, shopping carts, and dynamic product pricing.  
It supports two types of clients, three product categories, revenue-based price tiers, and exposes a full REST API.

---

### ðŸš€ Running the Application

Requirements:

* Java 21
* Gradle (wrapper included)
* Docker (optional)

```bash
Run with Gradle
./gradlew bootRun
```

App URL:
http://localhost:8080

Run with Docker

```bash
./gradlew clean bootJar
docker compose up --build
```

## API Testing Files (curl/http/*.http)

The project includes ready-to-use HTTP Client files (for IntelliJ, VS Code REST Client, or any HTTP file runner) that
allow testing the API quickly.

## ðŸ§± Architecture Overview

- **Controllers** â€” REST endpoints
- **Services** â€” business logic for clients, carts, pricing
- **Pricing Module** â€” YAML-based (default) or DB-based pricing
- **Persistence Layer** â€” JPA + Flyway migrations
- **Security** â€” HTTP Basic, demo users only
- **Caching** â€” shopping carts & optional price rule caching

### ðŸ”— API Endpoints

All business endpoints require HTTP Basic Auth.

## ðŸ¥ Health

| Endpoint           | Method | Access |
|--------------------|--------|--------|
| `/actuator/health` | GET    | Public |

## ðŸ‘¤ Clients (ADMIN only)

| Endpoint                         | Method | Description                           |
|----------------------------------|--------|---------------------------------------|
| `/api/clients/individual`        | POST   | Create individual client              |
| `/api/clients/professional`      | POST   | Create professional client            |
| `/api/clients/individual/{id}`   | GET    | Get individual client                 |
| `/api/clients/individual/{id}`   | PUT    | Update individual client              |
| `/api/clients/professional/{id}` | GET    | Get professional client               |
| `/api/clients/professional/{id}` | PUT    | Update professional client            |
| `/api/clients/individual`        | GET    | List individual clients (paginated)   |
| `/api/clients/professional`      | GET    | List professional clients (paginated) |

### Pagination Parameters

- `page`
- `size` (default: 20)

### Sample Seeded Clients

- **Individuals:** `C_IND_001`, `C_IND_002`
- **Professionals:** `C_PRO_LOW_001`, `C_PRO_HIGH_001`

## ðŸ›’ Shopping Carts (ADMIN or USER)

| Endpoint                             | Method | Description          |
|--------------------------------------|--------|----------------------|
| `/api/carts`                         | POST   | Create a cart        |
| `/api/carts/{cartId}`                | GET    | Retrieve cart        |
| `/api/carts/{cartId}/items`          | POST   | Add items            |
| `/api/carts/{cartId}/items/{itemId}` | PUT    | Update item quantity |
| `/api/carts/{cartId}/items/{itemId}` | DELETE | Remove item          |

## ðŸ” Security

The application has **Spring Security** enabled and all business endpoints require authentication.

- Access is protected with **HTTP Basic Authentication**
- Two **in-memory users** are configured (for demo purposes only)
- Credentials are stored in plain config only for demonstration (no Vault is used)

### Demo Credentials

| Role  | Username | Password |
|-------|----------|----------|
| Admin | `admin`  | `admin`  |
| User  | `user`   | `user`   |

Example authenticated request:

```bash
curl -u admin:admin \
  "http://localhost:8080/api/clients/professional?page=0&size=20"

```

## ðŸ§ª Tests

### Tests cover:

- Pricing logic for all product & revenue scenarios
- Cart total calculation
- Client operations
- Validation & error handling

### Run tests

```bash
./gradlew test
```

## ðŸ—„ï¸ Database Schema

### Clients

```sql
CREATE TABLE clients
(
    id                  VARCHAR(50) NOT NULL PRIMARY KEY,
    client_type         VARCHAR(20) NOT NULL, -- INDIVIDUAL / PROFESSIONAL

    -- individual
    first_name          VARCHAR(100),
    last_name           VARCHAR(100),

    -- professional
    company_name        VARCHAR(200),
    vat_number          VARCHAR(50),
    registration_number VARCHAR(50),
    annual_revenue      DECIMAL(19, 2)
);

CREATE TABLE shopping_carts
(
    id           BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    client_id    VARCHAR(50)    NOT NULL,
    total_amount DECIMAL(19, 2) NOT NULL DEFAULT 0,

    CONSTRAINT fk_cart_client
        FOREIGN KEY (client_id) REFERENCES clients (id)
);


CREATE TABLE cart_items
(
    id           BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    cart_id      BIGINT      NOT NULL,
    product_type VARCHAR(30) NOT NULL,
    quantity     INT         NOT NULL,

    CONSTRAINT fk_item_cart
        FOREIGN KEY (cart_id) REFERENCES shopping_carts (id)
);
```

## âš™ï¸ Pricing Engine

Two pricing implementations are available:

### 1. YAML-based Pricing (default)

- All required prices are stored in a YAML configuration file.
- Revenue tiers for professional clients are defined in the YAML as well.
- No database is required for pricing.

### 2. Database-based Pricing (optional)

Pricing is stored in the `price_rules` table, including:

- Client type
- Optional min/max revenue range
- Product type
- Unit price

Seed data matches the exerciseâ€™s pricing table exactly.

---

### ðŸ›  Pricing Mode Selection

Switch between implementations via application properties:

```properties
skycommerce.pricing.mode=yaml
```

The system supports three product types:

- High-end phone
- Mid-range phone
- Laptop

Prices depend on **client type** and **annual revenue**.

---

### Individuals

| Product         | Price |
|-----------------|-------|
| High-end phone  | â‚¬1500 |
| Mid-range phone | â‚¬800  |
| Laptop          | â‚¬1200 |

---

### Professional (revenue â‰¤ â‚¬10M)

| Product         | Price |
|-----------------|-------|
| High-end phone  | â‚¬1150 |
| Mid-range phone | â‚¬600  |
| Laptop          | â‚¬1000 |

---

### Professional (revenue > â‚¬10M)

| Product         | Price |
|-----------------|-------|
| High-end phone  | â‚¬1000 |
| Mid-range phone | â‚¬550  |
| Laptop          | â‚¬900  |

---

### Cart Total Formula

```
 total = Î£ (quantity Ã— unit price)
```
